# std::span è¯¦ç»†è§£æ

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
3. [æˆå‘˜å‡½æ•°è¯¦è§£](#æˆå‘˜å‡½æ•°è¯¦è§£)
4. [æ—¶é—´å¤æ‚åº¦](#æ—¶é—´å¤æ‚åº¦)
5. [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
6. [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

`std::span`æ˜¯C++20å¼•å…¥çš„**éæ‹¥æœ‰åºåˆ—è§†å›¾**ï¼Œæä¾›å¯¹è¿ç»­å†…å­˜çš„é›¶å¼€é”€æŠ½è±¡ã€‚

### å®šä¹‰ä½ç½®

```cpp
#include <span>
```

### æ¨¡æ¿å£°æ˜

```cpp
template<class T, size_t Extent = std::dynamic_extent>
class span;
```

- **T**: å…ƒç´ ç±»å‹
- **Extent**: å¤§å°ï¼ˆç¼–è¯‘æ—¶å¸¸é‡æˆ– `std::dynamic_extent` è¡¨ç¤ºåŠ¨æ€ï¼‰

### ä¸ºä»€ä¹ˆé€‰æ‹© std::spanï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ“¦ std::span çš„ä¼˜åŠ¿                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… é›¶å¼€é”€ï¼šç¼–è¯‘ä¸ºæŒ‡é’ˆ+å¤§å°ï¼Œæ— é¢å¤–å¼€é”€       â”‚
â”‚ âœ… é€šç”¨æ€§ï¼šé€‚ç”¨äºarrayã€vectorã€Cæ•°ç»„       â”‚
â”‚ âœ… éæ‹¥æœ‰ï¼šä¸ç®¡ç†å†…å­˜ï¼Œé¿å…æ‰€æœ‰æƒé—®é¢˜       â”‚
â”‚ âœ… ç±»å‹å®‰å…¨ï¼šç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œé¿å…æŒ‡é’ˆé”™è¯¯       â”‚
â”‚ âœ… çµæ´»å¤§å°ï¼šæ”¯æŒå›ºå®šå’ŒåŠ¨æ€å¤§å°             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| éæ‹¥æœ‰ | ä¸ç®¡ç†å†…å­˜ç”Ÿå‘½å‘¨æœŸ |
| é›¶å¼€é”€ | ç¼–è¯‘ä¸ºå•æŒ‡é’ˆ+å¤§å° |
| é€šç”¨ | é€‚ç”¨äºarrayã€vectorã€Cæ•°ç»„ |
| å›ºå®š/åŠ¨æ€ | æ”¯æŒç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶å¤§å° |
| åªè¯»/å¯å†™ | æ”¯æŒconstå’Œéconstè§†å›¾ |

---

## æˆå‘˜å‡½æ•°è¯¦è§£

### æ„é€ å‡½æ•°

```cpp
// 1. é»˜è®¤æ„é€ ï¼ˆç©ºspanï¼‰
std::span<int> s1;

// 2. ä»æ•°ç»„æ„é€ 
int arr[] = {1, 2, 3, 4, 5};
std::span<int> s2(arr);
std::span<int, 5> s3(arr);  // å›ºå®šå¤§å°

// 3. ä»vectoræ„é€ 
std::vector<int> v = {1, 2, 3};
std::span<int> s4(v);

// 4. ä»å¦ä¸€ä¸ªspanæ„é€ 
std::span<int> s5(s2);
```

### å…ƒç´ è®¿é—®

| å‡½æ•° | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| `operator[]` | O(1) | è®¿é—®æŒ‡å®šä½ç½® |
| `front()` | O(1) | è®¿é—®ç¬¬ä¸€ä¸ªå…ƒç´  |
| `back()` | O(1) | è®¿é—®æœ€åä¸€ä¸ªå…ƒç´  |
| `data()` | O(1) | è·å–æŒ‡é’ˆ |

```cpp
std::span<int> s(arr);

// è®¿é—®å…ƒç´ 
int first = s[0];
int last = s.back();
int* ptr = s.data();
```

### å­è§†å›¾æ“ä½œ

| å‡½æ•° | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| `first(count)` | O(1) | å‰countä¸ªå…ƒç´  |
| `last(count)` | O(1) | åcountä¸ªå…ƒç´  |
| `subspan(offset, count)` | O(1) | ä»offsetå¼€å§‹countä¸ªå…ƒç´  |

```cpp
std::span<int> s(arr);

// å­è§†å›¾
auto first_3 = s.first(3);      // {1, 2, 3}
auto last_2 = s.last(2);        // {4, 5}
auto sub = s.subspan(1, 3);     // {2, 3, 4}
```

### æŸ¥è¯¢æ“ä½œ

| å‡½æ•° | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| `size()` | O(1) | å…ƒç´ æ•°é‡ |
| `size_bytes()` | O(1) | å­—èŠ‚æ•° |
| `empty()` | O(1) | æ˜¯å¦ä¸ºç©º |

```cpp
std::span<int> s(arr);

std::cout << s.size();        // 5
std::cout << s.size_bytes();  // 20 (5 * sizeof(int))
std::cout << s.empty();       // false
```

---

## æ—¶é—´å¤æ‚åº¦

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ |
|------|-----------|
| æ„é€  | **O(1)** |
| è®¿é—® | **O(1)** |
| å­è§†å›¾ | **O(1)** |
| å¤§å°æŸ¥è¯¢ | **O(1)** |

---

## ä½¿ç”¨åœºæ™¯

### 1. å‡½æ•°å‚æ•°ï¼ˆé¿å…æ‹·è´ï¼‰

```cpp
// æ¥å—ä»»ä½•è¿ç»­å®¹å™¨
void process(std::span<const int> data) {
    for (int x : data) {
        std::cout << x << " ";
    }
}

// å¯ä»¥ä¼ é€’ä¸åŒç±»å‹
int arr[] = {1, 2, 3};
process(arr);

std::vector<int> v = {4, 5, 6};
process(v);

std::array<int, 3> a = {7, 8, 9};
process(a);
```

### 2. åˆ†å—å¤„ç†

```cpp
void process_chunks(std::span<const int> data, size_t chunk_size) {
    for (size_t i = 0; i < data.size(); i += chunk_size) {
        size_t count = std::min(chunk_size, data.size() - i);
        auto chunk = data.subspan(i, count);
        process(chunk);
    }
}
```

### 3. çŸ©é˜µæ“ä½œ

```cpp
// å°†1Dæ•°ç»„è§†ä¸º2DçŸ©é˜µ
void process_matrix(std::span<int> data, int rows, int cols) {
    for (int i = 0; i < rows; ++i) {
        auto row = data.subspan(i * cols, cols);
        process_row(row);
    }
}
```

### 4. å›ºå®šå¤§å°è§†å›¾

```cpp
// ç¼–è¯‘æ—¶å¤§å°æ£€æŸ¥
void process_fixed(std::span<int, 5> data) {
    // ç¼–è¯‘å™¨ä¿è¯å¤§å°ä¸º5
    for (int x : data) {
        std::cout << x << " ";
    }
}

int arr[5] = {1, 2, 3, 4, 5};
process_fixed(arr);  // OK
```

---

## æ³¨æ„äº‹é¡¹

### 1. ç”Ÿå‘½å‘¨æœŸç®¡ç†

```cpp
// âŒ å±é™©ï¼šspanæŒ‡å‘ä¸´æ—¶å¯¹è±¡
std::span<int> get_span() {
    int arr[] = {1, 2, 3};
    return std::span<int>(arr);  // arrç”Ÿå‘½å‘¨æœŸç»“æŸ
}

// âœ… æ­£ç¡®ï¼šspanæŒ‡å‘æœ‰æ•ˆå¯¹è±¡
std::vector<int> v = {1, 2, 3};
std::span<int> s(v);  // vä»ç„¶æœ‰æ•ˆ
```

### 2. å›ºå®šå¤§å°vsåŠ¨æ€å¤§å°

```cpp
// å›ºå®šå¤§å°ï¼ˆç¼–è¯‘æ—¶ï¼‰
std::span<int, 5> fixed;  // å¿…é¡»æ°å¥½5ä¸ªå…ƒç´ 

// åŠ¨æ€å¤§å°ï¼ˆè¿è¡Œæ—¶ï¼‰
std::span<int> dynamic;   // ä»»æ„å¤§å°
```

### 3. constæ­£ç¡®æ€§

```cpp
std::vector<int> v = {1, 2, 3};

// å¯ä¿®æ”¹å…ƒç´ 
std::span<int> s1(v);
s1[0] = 10;

// ä¸å¯ä¿®æ”¹å…ƒç´ 
std::span<const int> s2(v);
// s2[0] = 10;  // ç¼–è¯‘é”™è¯¯
```

---

## å¸¸è§é—®é¢˜

### Q1: span å’Œ vector çš„åŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | std::span | std::vector |
|------|-----------|------------|
| æ‹¥æœ‰å†…å­˜ | âŒ | âœ… |
| æ‹·è´å¼€é”€ | O(1) | O(n) |
| å¤§å°å¯å˜ | âŒ | âœ… |
| ç”Ÿå‘½å‘¨æœŸ | ä¾èµ–æº | è‡ªç®¡ç† |

### Q2: ä½•æ—¶ä½¿ç”¨ spanï¼Ÿ

âœ… **é€‚åˆ**ï¼š
- å‡½æ•°å‚æ•°ï¼ˆé¿å…æ‹·è´ï¼‰
- å¤„ç†ç°æœ‰å®¹å™¨çš„å­é›†
- ä¸C APIäº¤äº’
- é›¶å¼€é”€æŠ½è±¡

âŒ **ä¸é€‚åˆ**ï¼š
- éœ€è¦æ‹¥æœ‰æ•°æ® â†’ ä½¿ç”¨ vector
- éœ€è¦ä¿®æ”¹å¤§å° â†’ ä½¿ç”¨ vector
- éœ€è¦é•¿æœŸå­˜å‚¨ â†’ ä½¿ç”¨ vector

### Q3: å¦‚ä½•åˆ›å»ºå›ºå®šå¤§å°çš„spanï¼Ÿ

```cpp
int arr[5] = {1, 2, 3, 4, 5};

// æ–¹æ³•1ï¼šæ˜¾å¼æŒ‡å®šå¤§å°
std::span<int, 5> s1(arr);

// æ–¹æ³•2ï¼šä»std::array
std::array<int, 5> a = {1, 2, 3, 4, 5};
std::span<int, 5> s2(a);
```

### Q4: spanå¯ä»¥è½¬æ¢ä¸ºå…¶ä»–spanå—ï¼Ÿ

```cpp
std::vector<int> v = {1, 2, 3};
std::span<int> s1(v);

// åŠ¨æ€è½¬å›ºå®šï¼ˆè¿è¡Œæ—¶æ£€æŸ¥ï¼‰
std::span<int, 3> s2(s1);  // OK

// å¯å†™è½¬åªè¯»ï¼ˆéšå¼ï¼‰
std::span<const int> s3 = s1;  // OK
```

---

## æ€»ç»“

### ä½•æ—¶ä½¿ç”¨ std::span

âœ… **é€‚åˆ**ï¼š
- å‡½æ•°å‚æ•°æ¥å—ä»»æ„è¿ç»­å®¹å™¨
- å¤„ç†æ•°æ®çš„å­é›†
- é›¶å¼€é”€è§†å›¾
- ä¸C APIäº¤äº’

âŒ **ä¸é€‚åˆ**ï¼š
- éœ€è¦æ‹¥æœ‰æ•°æ® â†’ ä½¿ç”¨ vector
- éœ€è¦åŠ¨æ€è°ƒæ•´å¤§å° â†’ ä½¿ç”¨ vector
- éœ€è¦é•¿æœŸå­˜å‚¨ â†’ ä½¿ç”¨ vector

### æœ€ä½³å®è·µ

1. **ä½¿ç”¨spanä½œä¸ºå‡½æ•°å‚æ•°** è€ŒéæŒ‡é’ˆ+å¤§å°
2. **ä¼˜å…ˆä½¿ç”¨const span** è¡¨ç¤ºåªè¯»
3. **æ³¨æ„ç”Ÿå‘½å‘¨æœŸ** ç¡®ä¿æºå¯¹è±¡æœ‰æ•ˆ
4. **åˆ©ç”¨å­è§†å›¾** è¿›è¡Œé«˜æ•ˆçš„æ•°æ®åˆ†å‰²

---

## å‚è€ƒæ–‡æ¡£
- [cppreference - std::span](https://en.cppreference.com/w/cpp/container/span)
